<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2">
<meta http-equiv="Content-language" content="pl">
<meta name="Author" content="W³odzimierz Macewicz">
<meta name="Keywords" content="tex, odsy³acze, Wirtualna Akademia">
</head>
<body bgcolor=#f0a0f0>

<title>  Odsy³acze </title>


<center>
<h2>  Odsy³acze </h2>
<i></i><p>
<i></i><p>
autor: <i> <a href=mailto:ekotp@univ.gda.pl>Tomasz Przechlewski</a> </i>
</center>

<hr>

<h3> Wstêp </h3>

Istniej± systemy takie jak <strong>LaTeX</strong> (autor: Leslie Lamport),
<strong>AmSTeX</strong> (Michael Spivak), <strong>ConTeXt</strong> (Hans Hagen) czy <strong>eplain</strong> 
(Karl Berry) umo¿liwiaj±ce
automatyczne tworzenie odsy³aczy do ró¿nych elementów dokumentu
(tabele, rysunki, rozdzia³y, punkty, itp.). Zawieraj± one tak¿e wiele
innych, gotowych do wykorzystania funkcji, których nie ma formacie 
<strong>plain</strong>. Zadaniem tego tekstu nie jest ,,wywa¿anie drzwi do lasu''
ale raczej pokazanie w jaki sposób takie ,,zaawansowane'' funkcje s± 
implementowane. Przy okazji oka¿e siê, ¿e wcale nie jest to takie 
trudne jakby siê mog³o na pocz±tku wydawaæ.<p>

Prezentowany zestaw makr, z racji swojej prostoty, mo¿e byæ bardzo
³atwo modyfikowany przez u¿ytkownika w zale¿no¶ci od potrzeb. Jest to
podstawowa zaleta stosowania prostej TeX-niki a nie gotowych
formatów. Te ostatnie s± skomplikowane, a ich przystosowanie do w³asnych
potrzeb jest z regu³y bardzo trudne.

<h3> Problem </h3>

Odsy³acz to znak (liczba, cyfra, asteryks), umieszczony w sk³adzie
przy wyrazie, zwrocie lub fragmencie tekstu, odsy³aj±cy do obja¶nieñ
zawartych w innym miejscu tekstu. Czytelnik mo¿e byæ odes³any do
takich elementów tekstu jak:
tabela, rysunek, pocz±tek rozdzia³u, pocz±tek punktu, równanie 
matematyczne, pozycja bibliograficzna, inna strona dokumentu itp. 
Elementy te s± z regu³y identyfikowalne poprzez kolejny numer, 
którym s± oznaczone (mo¿e to byæ liczba naturalna, para liczb itp.). 
Jako odsy³acza u¿ywamy wtedy <i>numeru</i> elementu do, którego 
chcemy odes³aæ czytelnika. Przyk³ady u¿ycia odsy³aczy to:
<em>patrz tabela 6, porównaj punkt 2.5, z równania (4.5) wynika itd</em>. 
Je¿eli w tek¶cie nie stosuje siê odes³añ, zbêdne jest
numerowanie jakichkolwiek jego elementów (bo po co?).<p>

Wstawianie do dokumentu TeX-owego numerów rozdzia³ów, punktów, tabel
czy równañ oraz u¿ywanie tych numerów jako odsy³aczy jest z³±
praktyk±. Nale¿y przyj±æ zasadê, ¿e na etapie tworzenia pliku
¼ród³owego <i>ostateczne</i> numery tych elementów i odsy³acze do
nich <i>s± nam nie znane</i>. Elementy dokumentu winny byæ
numerowane automatycznie przez TeX-a <b>podczas jego kompilowania</b>
i w taki sam sposób (tzn. automatycznie) wstawiane odsy³acze. Tylko
postêpuj±c w ten sposób oszczêdzimy sobie wiele czasu podczas pracy
nad kolejnymi wersjami dokumentu.<p>

Ideê automatycznego wstawiania odsy³aczy przedstawimy na prostym
przyk³adzie systemu s³u¿±cego do numerowania równañ matematycznych.
Niech plik <code>fermat.tex</code> zawiera nastêpuj±cy kod:

<blockquote><small><code>
Równanie~(\ref{eq:fermat}) na 
s.~\pref{eq:fermat} przedstawia s³ynne 
twierdzenie Fermata:<br>
$$\eqalignno{%<br>
x^n + y^n &= z^n&\elab{eq:fermat}}$$<br>
Historia dowodzenia (\ref{eq:fermat})
ilustruje znaczenie dostatecznie 
szerokich marginesów...
</small></code>
</blockquote>

po kompilacji powinni¶my otrzymaæ nastêpuj±cy wynik:


<blockquote><small>
Równanie (1) na s. 1 przedstawia s³ynne twierdzenie Fermata:
<dd><img src=./fermat.gif width=300 height=25><br>
Historia dowodzenia (1) ilustruje znaczenie 
dostatecznie szerokich marginesów...
</small>
</blockquote>

Zauwa¿my, ¿e odno¶niki mog± wskazywaæ ,,w ty³'' (do tekstu ju¿ 
przeczytanego) jak i ,,w przód'' (do tekstu nie przeczytanego)
konieczne jest zatem dwukrotne kompilowanie dokumentu do ich
prawid³owego wyznaczenia (pierwsza kompilacja) i wstawienia.

U¿ytkownik pos³uguje siê w tym celu 
trzema nastêpuj±cymi instrukcjami:<br>

<dl>
<dt><code>\elab{etykieta}</code>
<dd>wstawia kolejny numer równania oraz definiuje
etykietê, której bêdziemy u¿ywaæ przy odwo³aniach 
do tego równania,

<dt><code>\pref{etykieta}</code>
<dd>wstawia numer strony na której znajduje siê równanie
oznakowane <i>etykiet±</i>.

<dt><code>\ref{etykieta}</code>
<dd>wstawia numer równania oznakowanego <i>etykiet±</i>.
</dl>

<h3> Rozwi±zanie </h3>

Ogólny schemat dzia³ania systemu jest nastêpuj±cy: 
W czasie pierwszej kompilacji instrukcja <code>\elab</code> zwiêksza warto¶æ 
licznika równañ o 1, wstawia do dokumentu bie¿±c± warto¶æ tego licznika 
oraz przesy³a do pliku dodatkowego trzy informacje: bie¿±cy numer strony, 
numer równania, etykietê. 
Podczas drugiej kompilacji TeX sprawdza czy ten
plik dodatkowy istnieje i je¿eli tak to zostaje on wczytany.
Zawarte tam informacje s± wykorzystywane przez instrukcje 
<code>\ref</code> i <code>\pref</code> do prawid³owego wstawienia odsy³aczy.<p>

Przejd¼my teraz do szczegó³ów. <p>

Zamiast definowaæ od razu komendê <code>\elab</code> zdefiniujemy najpierw 
makro <code>\defreference</code>, maj±ce dwa parametry, 
z których pierwszy bêdzie etykiet± dla odsy³acza, 
a drugi zawieraæ bêdzie sam odsy³acz 
<i>oraz</i> numer strony, na której
znajduje siê odes³anie.  
Na przyk³ad je¿eli TeX na 44 stronie 
dokumentu napotka³ definicjê 
<code>\defreference{eq:fermat}{\the\eqnC}</code><sup><a href=#fn1>1</a></sup>
to jej wykonanie powinno spowodowaæ wys³anie do pliku <code>fermat.crf</code>
nastêpuj±cej linii (zak³adamy, ¿e w chwili wykonywania
<code>\defreference</code> licznik <code>\eqnC</code> by³ równy 8):
<pre>
\crlab{eq:fermat}{{8}{44}}
</pre>
Co ma oznaczaæ, ¿e odsy³aczem dla etykiety <code>eq:fermat</code> jest 8, a odes³anie
wskazuje na stronê 44. Ni¿ej przedstawiona definicja  wykonuje zadanie 
zapisania odpowiedniej linii do pliku <code>fermat.crf</code>.
<pre>
1. \def\defreference#1#2{%
2. \edef\@tmp{\string\crlab
3. {#1}{{#2}{\noexpand\folio}}}%
4. \write\crfile\expandafter{\@tmp}}
</pre>
Makro to musi sobie poradziæ z podstawowym problemem: zapisania
jednocze¶nie prawid³owego numeru odno¶nika i prawid³owego numeru
strony na któr± ten odno¶nik wskazuje. Numer strony nie jest
znany <i>w momencie napotkania instrukcji</i> <code>\defreference</code>. Jest
on ustalany <i>w momencie wykonywania procedury wyj¶cia 
(output routine)</i>. 
Z drugiej strony odno¶nik jest znany i winien byæ zapisany <i>natychmiast</i>. 
Je¿eli jego rozwiniêcie zostanie opó¼nione to otrzymany numer 
bêdzie bie¿±cym numerem odno¶nika <i> w czasie wykonywania
tej procedury</i>.<p>


Problem ten jest rozwi±zywany w liniach 2--4 makrodefinicji
<code>\defreference</code>. Linie 2--3 definiuj± makro <code>\@tmp</code>. Zamiast
<code>\def</code> u¿yto <code>\edef</code> (<i>expanded definition</i>) co gwarantuje, ¿e
zawarto¶æ definicji <code>\@tmp</code> zostanie rozwiniêta <i>natychmiast</i>.
Nie ma to znaczenia gdy piszemy <code>\defreference{foo}{7}</code>, ale 
gdy odno¶nik jest ustalany automatycznie, np. 
<code>\defreference{foo}{\the\eqnC}</code>, to chodzi nam o bie¿±c± 
warto¶æ licznika a nie jego warto¶æ w chwili wykonywania
<i>output routine</i>.<p>

Sekwencja <code>\noexpand\folio</code> spowoduje, ¿e komenda
<code>\folio</code> (okre¶laj±ca numer strony), nie zostanie rozwiniêta przy
rozwijaniu zawarto¶ci definicji <code>\@tmp</code>. Zostanie to opó¼nione do
czasu rozwijania komendy <code>\write</code> podczas wykonywania <i>output
routine</i>.<p>

W linii 4 zawarto¶æ definicji <code>\@tmp</code> zostaje wys³ana do pliku
dodatkowego za pomoc± instrukcji <code>\write</code>. Konstrukcja:

<pre>
\write\crfile\expandafter{\@tmp}
</pre>
jest prostym przyk³adem zastosowania instrukcji <code>\expandafter</code>
w celu zmiany porz±dku rozwiniêcia dwóch ¿etonów (<i>tokens</i>)
<code>{</code> oraz <code>\@tmp</code>. Kiedy TeX napotka konstrukcjê <code>\write\crfile</code>
oczekuje nastêpnie ¿etonu <code>{</code> (por. <i>The TeXbook</i> str. 226), a potem
ci±gu ¿etonów koñcz±cego siê <code>}</code>, który zapisuje do pliku. 
Zapis do pliku jest <i>opó¼niony</i>, co oznacza, ¿e ca³y materia³
zawarty pomiêdzy klamrami <code>{</code> i <code>}</code> <i>nie</i> jest rozwijany
w chwili napotkania instrukcji <code>\write</code> <i>ale</i> umieszczany
jako tzw. <i>whatsit</i> na g³ównej li¶cie pionowej (<i>main
vertical list</i>) i rozwijany pó¼niej przy wykonywaniu <i>output 
routine</i> (por. <i>The TeXbook</i> str. 227).<p>

Jednak¿e wykonuj±c sekwencjê instrukcji z linii 4 TeX napotyka
<code>\expandafter</code> zamiast <code>{</code>. Powoduje to przeczytanie 
(czyli rozwiniêcie) przez
TeX-a najpierw makra <code>\@tmp</code> a dopiero potem
umieszczenie przed rozwiniêtym ju¿ makrem <code>\@tmp</code> ¿etonu <code>{</code>.
W efekcie na g³ówn± listê pionow±, do pó¼niejszego zapisu do pliku
<code>fermat.crf</code> wêdruje sekwencja ¿etonów tworz±ca makro <code>\@tmp</code> a nie
¿eton <code>\@tmp</code>, który jest od tej chwili gotowy do u¿ycia w nastêpnej
instrukcji <code>\defreference</code>. Gdyby na g³ówn± listê pionow± trafia³
¿eton <code>\@tmp</code> rozwijany podczas wykonywania <em>output routine</em>
to zawarto¶æ (<em>meaning</em>) wszystkich ¿etonów by³aby jednakowa
i równa zawarto¶ci ostatniego zdefiniowanego ¿etonu <code>\@tmp</code> --- rezultat 
ca³kowicie ró¿ny od poprzedniego i raczej przez nas nie oczekiwany!<p>

Makro <code>\elab</code> mo¿na zdefiniowaæ nastêpuj±co: 
<pre>
5. \newcount\eqnC
6. \def\elab#1{\global\advance\eqnC 1
7. \defreference{#1}{\the\eqnC}%
8. (\the\eqnC)}
</pre>
Po pierwszej kompilacji plik <code>fermat.crf</code> zawiera informacje o wszystkich 
odsy³aczach, które wykorzystujemy przy powtórnej kompilacji dokumentu. 
W tym celu najpierw zdefiniujemy komendê <code>\crlab</code>. Jak widaæ wy¿ej, 
posiada ona dwa parametry, z których pierwszy zawiera etykietê odsy³acza
a drugi ³±cznie odsy³acz oraz numer strony, na której 
odes³anie siê znajduje.
Zarówno odsy³acz, jak i numer strony zawarte s± 
w parze nawiasów klamrowych.

<pre>
9. \def\crlab#1#2{%
10.  \global\expandafter
11.  \def\csname #1\endcsname{#2}}
</pre>
Wykonanie makra <code>\crlab{eq:fermat}{{8}{44}}</code> 
spowoduje utworzenie nowego makra o nazwie <code>eq:fermat</code> 
rozwijaj±cego siê dok³adnie do <code>{8}{44}</code>. 
Wykorzystanie konstrukcji <code>\csname</code>...<code>\endcsname</code> umo¿liwia definiowanie 
etykiet zawieraj±cych znaki o dowolnych ,,egzotycznych'' kodach, 
np. <code>&</code>, <code>:</code>, <code>#</code>, itd. Wrêcz wskazane jest umieszczenie takich znaków,
co zapobiegnie niezamierzonej zmianie znaczenia ,,normalnych'' makr
o przypadkowo identycznej nazwie.

Teraz mo¿emy zdefiniowaæ instrukcjê <code>\ref</code>. Makro to powinno
wstawiaæ odsy³acz a pomijaæ numer strony.  Kopiujemy w tym celu
pomys³owe rozwi±zanie tego problemu z formatu {\LaTeX}, w którym
znowu w roli g³ównej wystêpuje instrukcja <code>\expandafter</code>:

<pre>
12. \def\@car#1#2{#1}
13. \def\ref#1{%
14.  \edef\@tempa{\csname #1\endcsname}
15. \expandafter\@car\@tempa}
</pre>
Makrodefinicja <code>\ref</code> ma jeden argument --- etykietê odno¶nika. W linii 
14 tworzona jest instrukcja <code>\@tempa</code>, której zawarto¶ci± jest wykonanie 
makrodefinicji o nazwie to¿samej z nazw± etykiety. W nastêpnej linii
najpierw rozwijana jest instrukcja <code>\@tempa</code>, co oznacza rozwiniêcie
jej zawarto¶ci do postaci 
<code>{<em>odno¶nik</em>}{<em>strona</em>}</code>. 
Nastêpnie rozwijane jest makro <code>\@car</code>, które z dwóch swoich
parametrów wstawia pierwszy a pomija drugi. Proste!<p>

Skonstruowane w analogiczny sposób makro <code>\pref</code> wstawia 
numer strony a pomija odno¶nik:

<pre>
16. \def\@cdr#1#2{#2}
17. \def\pref#1{%
18.  \edef\@tempa{\csname #1\endcsname}
19.  \expandafter\@cdr\@tempa}
</pre>
Teraz okre¶lmy wreszcie plik, z którego <em>pobierane</em> 
bêd± odno¶niki a nastêpnie otwórzmy go do czytania:

<pre>
20. \newread\crfile
21. \openin\crfile=\jobname.crf
22. \input \jobname.crf
</pre>
Powy¿szy kod ma jeden powa¿ny minus. Mianowicie gdyby z jakich¶
wzglêdów plik <code>fermat.crf</code> nie istnia³ (w pierwszej kompilacji
dokumentu na pewno go nie bêdzie)
to wtedy próba wykonania linii
<code>\input \jobname.crf</code> spowoduje b³±d <code>I can't find file fermat.crf</code>. 
Lepiej zabezpieczyæ siê na tê okoliczno¶æ u¿ywaj±c komendy <code>\ifeof</code>. Tak
wiêc w powy¿szym fragmencie kodu ostatni± liniê nale¿y zast±piæ przez:

<pre>
22. \ifeof\crfile \else
23.   \input \jobname.crf \fi
</pre>
Wreszcie pozostaje do zdefiniowania plik do którego bêd± <i>wysy³ane</i> 
informacje o odes³aniach:

<pre>
24. \newwrite\crfile
25. \openout\crfile=\jobname.crf
</pre>
I te 25 linii kodu pokazane wy¿ej wystarcz± dla TeX-a do prawid³owego 
wstawienia odpowiednich odsy³aczy.
Wystarcz± TeX-owi ale nie TeX-owcowi, który z pewno¶ci± pope³niaæ 
bêdzie b³êdy. Dlatego powy¿sze makra nale¿y rozbudowaæ o obs³ugê 
b³êdów i ostrze¿eñ. W szczególno¶ci nale¿y zadbaæ o ostrzeganie 
u¿ytkownika o:

<ul>
<li>odwo³aniu siê do niezdefiniowanej etykiety. W tym przypadku system 
powinien wys³aæ komunikat do pliku <code>.log</code> 
i na ekran a tak¿e
oznakowaæ brakuj±ce odno¶niki w sk³adanym dokumencie,
<li>dwukrotnym (lub wielokrotnym) zdefiniowanie tej samej etykiety. 
W tym przypadku system powinien wys³aæ odpowiedni
komunikat do pliku <code>.log</code> i na ekran.
</ul>
Poniewa¿ w przedstawionych wy¿ej makrach u¿ywamy znaku <code>@</code>
w nazwach komend, powinny zostaæ one zawarte pomiêdzy liniami:

<pre>
\catcode`@=11
...
\catcode`@=12
</pre>

<h3> Makra </h3>

Prezentowany poni¿ej zestaw makr jest dostêpny na komputerze
<code>ftp.gust.org.pl</code> w katalogu <code>TeX/GUST/bulletin/05</code>
--- plik <code>tp-crf.tex</code>. W porównaniu do
przedstawionych ju¿ makrodefinicji dodano nastêpuj±ce wa¿niejsze komendy:

<dl>
<dt><code>\nocrwarns</code>
<dd>Ostrze¿enia o b³êdach nie s± wy¶wietlane na ekranie
(przydatne na wstêpnym etapie pracy nad dokumentem),

<dt><code>\nocrfile</code>
<dd>Dodatkowy plik nie jest odtwarzany,

<dt><code>\makecrfile</code>
<dd>Dodatkowy plik jest tworzony,

<dt><code>\crstatistics</code>
<dd>Wy¶wietlenie sumarycznej informacji o u¿ytych odsy³aczach.
Przedefiniowana komenda <code>\bye</code> wywo³uje to makro.
</dl>


<pre>
%% --------------------------------
%% Cross-reference generic macros
%% Tomasz Przechlewski
%% Date: 02.01.1995
%% --------------------------------
\catcode`@=11
\def\@crwrn#1{\if@crwrns\immediate
\write16{#1}\fi}
\def\@markmissingcr{{\bf ??}\@marginmarker}
\def\@marginmarker{\vadjust{\vbox to0pt{%
\kern-.77\normalbaselineskip
\hbox{{\it\kern\hsize\kern15pt?}}\vss}}}

\newif\if@crwrns 
\global\@crwrnstrue % default
\def\nocrfile{\global\@crfilefalse}
\def\nocrwrns{\global\@crwrnsfalse}

\def\@car#1#2{#1}
\def\@cdr#1#2{#2}

\long\def\@ifundefined#1#2#3{%
 \expandafter\ifx\csname
 #1\endcsname\relax#2\else#3\fi}

\def\namedef#1{\expandafter
  \def\csname #1\endcsname}

\def\newlabel#1#2{\@ifundefined{#1}{}%
{\@crwrn{-> WARNING: multiple label #1}}%
\global\namedef{#1}{#2}}
\newread\crfile

\openin\crfile=\jobname.crf
\ifeof\crfile
  \@crwrn{-> WARNING: CR-FILE UNDEFINED!!}
 \else
  \@crwrn{READING REFS FROM \jobname.crf}
  \input \jobname.crf
\fi
\closein\crfile

\def\makecrfile{%
  \openout\crfile=\jobname.crf}
\def\nocrfile{\@crwrn{-> WARNING: 
        CR-FILE not created}
 \def\crfile{-1}}

\def\ref#1{\@nextcrf\@ifundefined{#1}{%
 \@markmissingcr
 \@crwrn{undefined cr -> \string#1}}%
 {\edef\@tempa{\csname #1\endcsname}
 \expandafter \@car\@tempa}}

\def\pageref#1{\@nextpcrf
 \@ifundefined{#1}{\@markmissingcr
 \@crwrn{undefined cr -> \string#1}}%
 {\edef\@tempa{\csname #1\endcsname}%
 \expandafter \@cdr\@tempa}}

\def\defreference#1#2{\@nextdrf%
 \edef\save{\string\newlabel{#1}%
 {{#2}{\noexpand\folio}}}%
 \write\crfile\expandafter{\save}}

\newcount\@crfC\newcount\@pcrfC
\newcount\@dcrfC
\def\@nextdrf{\global\advance\@dcrfC1}
\def\@nextcrf{\global\advance\@crfC1}
\def\@nextpcrf{\global\advance\@pcrfC1}
\def\crstatistics{%
\@crwrn{==============================}
\@crwrn{= REFERENCE STATISTICS =======}
\@crwrn{= refs defined.... \the\@dcrfC}
\@crwrn{= refs used....... \the\@crfC}
\@crwrn{= page refs used.. \the\@pcrfC}
\@crwrn{==============================}}
\outer\def\bye{\crstatistics\end}
\catcode`@=12
\endinput
</pre>

<h3> Bibliografia</h3>

<ol>
<li>
Knuth D. E., <i>The TeXbook</i>, Addison-Weley, Reading MA: 1986.

<li>
Salomon D., Macros for Indexing and Table-of Contents Preparation, 
<code><i>TUGboat</i></code>, 10(3): s. 394--400.
</ol>


<h3>Przypisy</h3>

<hr align=left width=20%>
<sup><a name=fn1><b>1</b></a></sup>Wystêpuj±ce w poni¿szym opisie nazwy i 
konstrukcje prêdzej lub pó¼niej zostan± wyja¶nione.



<hr>
<a href=../index.html><img src="../gify/lew-7vs.gif" hspace=10 border=0 align=left></a>
<a href=http://www.gumbeers.elka.pg.gda.pl/WA><img src="../gify/wa.gif" hspace=10 align=left></a>
<a href=mailto:W.Macewicz@ia.pw.edu.pl><img src="../gify/mail.gif" hspace=10 align=left></a>
Zredagowa³</br>
<a href=http://home.elka.pw.edu.pl/~macewicz/index.html>W³odzimierz Macewicz</a><br clear=all>
<hr>
Ostatnie zmiany: 07.04.2001 (StaW). 
</body>
</html>
